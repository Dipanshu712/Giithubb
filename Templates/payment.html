{% extends "base.html" %}
{% load humanize %}
{% block title %}Secure Payment{% endblock %}

{% block body %}
<main>
  <section class="shop-checkout container py-5">

    <style>
      body {
        background-color: #f8f9fa;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }
      .card {
        border: none;
        border-radius: 12px;
      }
      #rzp-button1 {
        background-color: #28a745;
        border: none;
        border-radius: 6px;
        transition: all 0.3s ease;
      }
      #rzp-button1:hover {
        background-color: #218838;
        box-shadow: 0 4px 15px rgba(33, 136, 58, 0.3);
      }
    </style>

    <div class="container text-center">
      <div class="card shadow mx-auto mb-4" style="max-width: 500px;">
        <div class="card-body">
          <h4 class="card-title mb-3 fw-semibold">Order Summary</h4>

          {% if display_amount %}
            <p class="fs-5 mb-1">
              Amount:
              <strong>â‚¹ {{ display_amount|floatformat:"2"|intcomma }}</strong>
            </p>
          {% else %}
            <p class="text-danger">Amount not available.</p>
          {% endif %}

          {% if razorpay_order_id %}
            <p class="mb-3">Order ID: <span class="text-muted">{{ razorpay_order_id }}</span></p>
          {% endif %}

          <button id="rzp-button1" class="btn btn-success btn-lg px-5 fw-bold">
            Pay â‚¹ {{ display_amount|floatformat:"2"|intcomma }}
          </button>

          <div class="mt-4 text-muted">
            <small>ðŸ”’ Secure payment powered by <strong>Razorpay</strong></small>
          </div>
        </div>
      </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": "{{ amount }}",
        "currency": "{{ currency }}",
        "name": "Your Shop",
        "description": "Order Payment",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function (response) {
          // Create and submit hidden form to backend
          var form = document.createElement("form");
          form.method = "POST";
          form.action = "{{ callback_url }}";

          // CSRF token for Django
          var csrfToken = "{{ csrf_token }}";
          var tokenInput = document.createElement("input");
          tokenInput.type = "hidden";
          tokenInput.name = "csrfmiddlewaretoken";
          tokenInput.value = csrfToken;
          form.appendChild(tokenInput);

          // Razorpay response fields
          var fields = {
            "razorpay_payment_id": response.razorpay_payment_id,
            "razorpay_order_id": response.razorpay_order_id,
            "razorpay_signature": response.razorpay_signature
          };
          for (var field in fields) {
            var input = document.createElement("input");
            input.type = "hidden";
            input.name = field;
            input.value = fields[field];
            form.appendChild(input);
          }

          document.body.appendChild(form);
          form.submit();
        },
        "theme": { "color": "#3399cc" }
      };
      var rzp1 = new Razorpay(options);
      document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
      }
    </script>
  </section>
</main>
{% endblock %}
